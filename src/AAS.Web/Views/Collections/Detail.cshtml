@model AAS.Web.Models.Collection
@inject Microsoft.Extensions.Localization.IStringLocalizer<SharedResources> L
@using System.Web
@{
  var images = Model.Images.OrderBy(i => i.SortOrder).ToList();
}

<div class="section">
  <div class="container">
    <nav aria-label="breadcrumb" class="mb-4">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">@L["Home"]</a></li>
        <li class="breadcrumb-item"><a href="/Collections">@L["Collections"]</a></li>
        <li class="breadcrumb-item active" aria-current="page">@(ViewBag.TranslatedTitle as string ?? Model.Title)</li>
      </ol>
    </nav>

    <div class="row g-4">
      <div class="col-12 col-lg-7">
        <div class="card">
          <div class="swiper mySwiper">
            <div class="swiper-wrapper">
              @foreach(var i in images){
                <div class="swiper-slide">
                  <img class="gallery-image w-100" alt="@Model.Title" style="width: 100%; height: 500px; object-fit: cover; cursor: zoom-in;"
                       src="/uploads/images/@i.FileName-960.jpg"
                       data-full="/uploads/images/@i.FileName-1600.jpg"
                       srcset="/uploads/images/@i.FileName-480.jpg 480w, /uploads/images/@i.FileName-960.jpg 960w, /uploads/images/@i.FileName-1600.jpg 1600w" />
                </div>
              }
            </div>
            <div class="swiper-pagination"></div>
            <div class="swiper-button-prev">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="15 18 9 12 15 6"></polyline>
              </svg>
            </div>
            <div class="swiper-button-next">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </div>
          </div>
          
          @* Price and Status display directly under photos *@
          <div class="card-body p-3">
            <div class="d-flex justify-content-between align-items-center">
              @if (Model.Status == AAS.Web.Models.CollectionStatus.Sold)
              {
                <div class="flex-grow-1">
                  <span class="badge bg-danger fs-5 px-4 py-2">@L["Sold"]</span>
                </div>
              }
              else if (Model.Status == AAS.Web.Models.CollectionStatus.InAuction)
              {
                <div class="flex-grow-1">
                  <span class="badge bg-warning fs-5 px-4 py-2">@L["InAuction"]</span>
                </div>
              }
              else if (Model.Status == AAS.Web.Models.CollectionStatus.Available)
              {
                @if (Model.Price.HasValue)
                {
                  <div class="d-flex justify-content-between align-items-center w-100">
                    <div>
                      <span class="badge bg-success fs-6 px-3 py-2">@L["Available"]</span>
                    </div>
                    <div class="text-end">
                      <div class="text-muted small">@L["Available for"]</div>
                      <h4 class="mb-0 fw-bold" style="color: var(--gold);">
                        @if (Model.Currency == AAS.Web.Models.Currency.EUR)
                        {
                          @string.Format("{0:N0} â‚¬", Model.Price)
                        }
                        else
                        {
                          @string.Format("$ {0:N0}", Model.Price)
                        }
                      </h4>
                    </div>
                  </div>
                }
                else
                {
                  <div class="flex-grow-1">
                    <span class="badge bg-success fs-6 px-3 py-2">@L["Available"]</span>
                  </div>
                }
              }
            </div>
            
            @* I'm Interested button directly under price/status *@
            @if (Model.Status == AAS.Web.Models.CollectionStatus.Available)
            {
              <div class="mt-3">
                <button class="btn btn-primary w-100 btn-lg" data-bs-toggle="modal" data-bs-target="#interestModal">
                  @L["I'm interested"]
                </button>
              </div>
            }
            
            @* Comments Section - Directly Below Button *@
            <div class="mt-4">
              <h5 class="mb-3">@L["Comments"]</h5>
              
              @* Comment Form (only for logged in users) *@
              @if (User.Identity?.IsAuthenticated == true)
              {
                <div class="mb-3 p-3 bg-light rounded">
                  <form id="commentForm">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="collectionId" value="@Model.Id" />
                    <div class="mb-2">
                      <textarea class="form-control" id="commentText" name="text" rows="3" maxlength="2000" required placeholder="@L["Write your comment..."]"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm">@L["Submit Comment"]</button>
                  </form>
                </div>
              }
              else
              {
                <div class="alert alert-info mb-3">
                  <a href="/Identity/Account/Login?returnUrl=@HttpUtility.UrlEncode(Context.Request.Path)">@L["Sign in"]</a> @L["to leave a comment"]
                </div>
              }
              
              @* Comments List *@
              <div id="commentsList">
                <div class="text-center py-3">
                  <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        @if(!string.IsNullOrEmpty(Model.AudioPath)){
          <div class="card mt-3">
            <div class="card-body">
              <h5>@L["Audio Description"]</h5>
              <audio controls class="w-100" src="@Model.AudioPath"></audio>
            </div>
          </div>
        }
      </div>
      
      <div class="col-12 col-lg-5">
        <div class="card">
          <div class="card-body p-4">
            <span class="badge badge-gold mb-3">@L[Model.Category.ToString()]</span>
            
            @* AAS Verified Badge *@
            @if (Model.AASVerified)
            {
              <div class="alert alert-success d-flex align-items-center mb-3" role="alert">
                <img src="~/images/aas-verified-badge.svg" alt="AAS Verified" style="width: 40px; height: 40px; margin-right: 15px;" />
                <div>
                  <strong>@L["AASVerified"]</strong><br/>
                  <small>@L["AASVerifiedTooltip"]</small>
                </div>
              </div>
            }
            
            <h1 style="font-size: 2rem;" class="mb-4">@Html.Raw(Html.Encode(ViewBag.TranslatedTitle as string ?? Model.Title))</h1>
            
            <div style="white-space: pre-wrap;">
              @Html.Raw(Html.Encode(ViewBag.TranslatedDescription as string ?? Model.Description).Replace("\n", "<br/>"))
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Lightbox Modal for Full Screen Gallery -->
<div class="modal fade" id="lightboxModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="true" data-bs-keyboard="true">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content bg-black">
      <div class="modal-header border-0" style="position: absolute; top: 0; right: 0; z-index: 1060; background: rgba(0,0,0,0.5);">
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0 d-flex align-items-center justify-content-center">
        <div class="swiper lightboxSwiper" style="width: 100%; height: 100vh;">
          <div class="swiper-wrapper">
            @foreach(var i in images){
              <div class="swiper-slide d-flex align-items-center justify-content-center">
                <img alt="@Model.Title" style="max-width: 95%; max-height: 95vh; object-fit: contain;"
                     src="/uploads/images/@i.FileName-1600.jpg" />
              </div>
            }
          </div>
          <div class="swiper-pagination"></div>
          <div class="swiper-button-prev">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
          </div>
          <div class="swiper-button-next">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="interestModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">@L["Send inquiry"]</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-secondary mb-4">Fill out the form below and our specialist will contact you within 12 hours.</p>
        <form id="inqForm">
          @Html.AntiForgeryToken()
          <input type="hidden" name="collectionId" value="@Model.Id" />
          <input type="hidden" name="collectionTitle" value="@Model.Title" />
          <div class="mb-3">
            <label class="form-label">@L["First name"]</label>
            <input class="form-control" name="FirstName" maxlength="100" required />
          </div>
          <div class="mb-3">
            <label class="form-label">@L["Last name"]</label>
            <input class="form-control" name="LastName" maxlength="100" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input class="form-control" name="Email" type="email" maxlength="160" required />
          </div>
          <div class="mb-3">
            <label class="form-label">@L["Phone"]</label>
            <input class="form-control" name="Phone" type="tel" maxlength="40" />
          </div>
          <div class="mb-3">
            <label class="form-label">@L["Message"]</label>
            <textarea class="form-control" name="Message" rows="4" maxlength="5000" placeholder="Tell us about your interest..."></textarea>
          </div>
        </form>
        <div id="inqOk" class="alert alert-success d-none">@L["Thank you. We will contact you soon."]</div>
        <div id="inqError" class="alert alert-danger d-none"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">@L["Close"]</button>
        <button type="button" class="btn btn-primary" onclick="submitInquiry()">@L["Send"]</button>
      </div>
    </div>
  </div>
</div>

@section Scripts{
<script>
// Debug Bootstrap Modal
console.log('Bootstrap version:', typeof bootstrap !== 'undefined' ? bootstrap : 'NOT LOADED');
console.log('Modal element:', document.getElementById('interestModal'));

// Test modal manually
document.addEventListener('DOMContentLoaded', function() {
  console.log('Testing Bootstrap modal functionality...');
  
  const modalEl = document.getElementById('interestModal');
  if (modalEl) {
    console.log('Modal element found');
    
    // Try to create modal instance
    try {
      const testModal = new bootstrap.Modal(modalEl);
      console.log('Modal instance created successfully:', testModal);
    } catch (error) {
      console.error('Error creating modal instance:', error);
    }
  } else {
    console.error('Modal element NOT found!');
  }
  
  console.log('DOMContentLoaded - Initializing Swiper...');
  
  // Wait for Swiper to be available
  var initAttempts = 0;
  var maxAttempts = 10;
  
  function tryInitSwiper() {
    initAttempts++;
    
    if (typeof Swiper !== 'undefined') {
      console.log('Swiper found! Initializing galleries...');
      
      // Main gallery
      var mainSwiper = new Swiper('.mySwiper', {
        loop: true,
        spaceBetween: 10,
        pagination: {
          el: '.mySwiper .swiper-pagination',
          clickable: true,
          type: 'bullets'
        },
        navigation: {
          nextEl: '.mySwiper .swiper-button-next',
          prevEl: '.mySwiper .swiper-button-prev'
        },
        keyboard: {
          enabled: true,
          onlyInViewport: false
        }
      });
      
      console.log('Main Swiper initialized successfully!');
      
      // Lightbox
      var lightboxSwiper = null;
      var lightboxModal = document.getElementById('lightboxModal');
      
      if (lightboxModal) {
        lightboxModal.addEventListener('shown.bs.modal', function() {
          console.log('Lightbox modal opened');
          
          if (!lightboxSwiper) {
            lightboxSwiper = new Swiper('.lightboxSwiper', {
              loop: true,
              spaceBetween: 10,
              pagination: {
                el: '.lightboxSwiper .swiper-pagination',
                clickable: true,
                type: 'bullets'
              },
              navigation: {
                nextEl: '.lightboxSwiper .swiper-button-next',
                prevEl: '.lightboxSwiper .swiper-button-prev'
              },
              keyboard: {
                enabled: true,
                onlyInViewport: false
              }
            });
            console.log('Lightbox Swiper initialized!');
          } else {
            lightboxSwiper.update();
          }
        });
        
        // Open lightbox on image click
        document.querySelectorAll('.gallery-image').forEach(function(img, idx) {
          img.addEventListener('click', function() {
            console.log('Image clicked, opening lightbox');
            mainSwiper.slideTo(idx);
            var bsModal = new bootstrap.Modal(lightboxModal);
            bsModal.show();
          });
        });
        
        console.log('Lightbox event listeners attached');
      }
      
    } else if (initAttempts < maxAttempts) {
      console.log('Swiper not ready yet, attempt ' + initAttempts + '/' + maxAttempts);
      setTimeout(tryInitSwiper, 200);
    } else {
      console.error('Swiper failed to load after ' + maxAttempts + ' attempts');
    }
  }
  
  tryInitSwiper();
  
  // Debug: Add event listener to "I'm interested" button
  const interestedBtn = document.querySelector('button[data-bs-target="#interestModal"]');
  if (interestedBtn) {
    console.log('Found I\'m interested button:', interestedBtn);
    
    interestedBtn.addEventListener('click', function(e) {
      console.log('Button clicked!', e);
      console.log('Bootstrap available:', typeof bootstrap !== 'undefined');
      console.log('Modal element exists:', document.getElementById('interestModal'));
    });
  } else {
    console.error('I\'m interested button NOT found!');
  }
});

// Comments functionality
document.addEventListener('DOMContentLoaded', function() {
  const collectionId = @Model.Id;
  const isAuthenticated = @(User.Identity?.IsAuthenticated == true ? "true" : "false");
  const isAdmin = @(User.IsInRole("Admin") ? "true" : "false");
  
  // Load comments
  loadComments();
  
  function loadComments() {
    console.log('Loading comments for collection:', collectionId);
    fetch(`/api/Comments/collection/${collectionId}`)
      .then(response => {
        console.log('Comments API response status:', response.status);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(comments => {
        console.log('Loaded comments:', comments.length, comments);
        renderComments(comments);
      })
      .catch(error => {
        console.error('Error loading comments:', error);
        document.getElementById('commentsList').innerHTML = '<div class="alert alert-danger">@L["Failed to load comments"]</div>';
      });
  }
  
  function renderComments(comments) {
    console.log('renderComments called with:', comments);
    const container = document.getElementById('commentsList');
    console.log('commentsList container:', container);
    
    if (!container) {
      console.error('commentsList container not found!');
      return;
    }
    
    if (comments.length === 0) {
      container.innerHTML = '<p class="text-muted">@L["No comments yet. Be the first to comment!"]</p>';
      return;
    }
    
    const currentUserId = '@User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value';
    console.log('Current user ID:', currentUserId, 'isAuthenticated:', isAuthenticated, 'isAdmin:', isAdmin);
    
    try {
      let html = '';
      comments.forEach((comment, index) => {
        console.log(`Processing comment ${index}:`, comment);
        
        const date = new Date(comment.createdAt).toLocaleDateString('@System.Globalization.CultureInfo.CurrentCulture.Name');
        const updated = comment.updatedAt ? ' <small class="text-muted">(@L["edited"])</small>' : '';
        const safeUserName = escapeHtml(comment.userName || 'Unknown');
        const safeText = escapeHtml(comment.text || '');
        
        html += `
          <div class="card mb-3" data-comment-id="${comment.id}">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <strong>${safeUserName}</strong>
                  <small class="text-muted ms-2">${date}${updated}</small>
                </div>`;
        
        // Show edit/delete buttons if user is owner or admin
        if (isAuthenticated && (comment.userId === currentUserId || isAdmin)) {
          const dataText = safeText.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
          html += `
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-primary btn-sm" onclick="editComment(${comment.id}, this.getAttribute('data-text'))" data-text="${dataText}">@L["Edit"]</button>
                  <button class="btn btn-outline-danger btn-sm" onclick="deleteComment(${comment.id})">@L["Delete"]</button>
                </div>`;
        }
        
        html += `
              </div>
              <p class="mt-2 mb-0 comment-text">${safeText}</p>
            </div>
          </div>`;
      });
      
      console.log('Final HTML length:', html.length);
      console.log('Setting innerHTML...');
      container.innerHTML = html;
      console.log('Comments rendered successfully');
      
      // Scroll to comments if not visible
      setTimeout(() => {
        const rect = container.getBoundingClientRect();
        console.log('Container position:', rect);
        if (rect.top < 0 || rect.bottom > window.innerHeight) {
          console.log('Scrolling to comments...');
          container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      }, 100);
    } catch (error) {
      console.error('Error rendering comments:', error);
      container.innerHTML = '<div class="alert alert-danger">Error displaying comments. Please refresh the page.</div>';
    }
  }
  
  // Submit new comment
  if (isAuthenticated) {
    document.getElementById('commentForm')?.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      const token = this.querySelector('[name="__RequestVerificationToken"]').value;
      
      fetch('/api/Comments', {
        method: 'POST',
        headers: {
          'X-CSRF-TOKEN': token,
          'RequestVerificationToken': token
        },
        body: formData
      })
      .then(response => {
        if (!response.ok) {
          return response.text().then(text => {
            console.error('Server response:', text);
            throw new Error('Failed to post comment');
          });
        }
        return response.json();
      })
      .then(data => {
        console.log('Comment created:', data);
        document.getElementById('commentText').value = '';
        loadComments();
      })
      .catch(error => {
        console.error('Error:', error);
        alert('@L["Failed to post comment. Please try again."]');
      });
    });
  }
  
  // Edit comment
  window.editComment = function(commentId, currentTextElement) {
    // Get text from data attribute
    let currentText = '';
    if (typeof currentTextElement === 'string') {
      currentText = currentTextElement;
    } else if (currentTextElement && currentTextElement.getAttribute) {
      currentText = currentTextElement.getAttribute('data-text') || '';
    }
    
    // Decode HTML entities
    const textarea = document.createElement('textarea');
    textarea.innerHTML = currentText;
    const decodedText = textarea.value;
    
    const newText = prompt('@L["Edit your comment:"]', decodedText);
    if (newText === null || newText.trim() === '' || newText === decodedText) return;
    
    const formData = new FormData();
    formData.append('text', newText);
    
    const token = document.querySelector('[name="__RequestVerificationToken"]').value;
    
    fetch(`/api/Comments/${commentId}`, {
      method: 'PUT',
      headers: {
        'RequestVerificationToken': token
      },
      body: formData
    })
    .then(response => {
      if (!response.ok) throw new Error('Failed to update comment');
      loadComments();
    })
    .catch(error => {
      console.error('Error:', error);
      alert('@L["Failed to update comment. Please try again."]');
    });
  };
  
  // Delete comment
  window.deleteComment = function(commentId) {
    if (!confirm('@L["Are you sure you want to delete this comment?"]')) return;
    
    const token = document.querySelector('[name="__RequestVerificationToken"]').value;
    
    fetch(`/api/Comments/${commentId}`, {
      method: 'DELETE',
      headers: {
        'RequestVerificationToken': token
      }
    })
    .then(response => {
      if (!response.ok) throw new Error('Failed to delete comment');
      loadComments();
    })
    .catch(error => {
      console.error('Error:', error);
      alert('@L["Failed to delete comment. Please try again."]');
    });
  };
  
  // Utility function to escape HTML
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
});
</script>
}
