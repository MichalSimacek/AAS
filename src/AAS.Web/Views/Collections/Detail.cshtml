@model AAS.Web.Models.Collection
@inject Microsoft.Extensions.Localization.IStringLocalizer<SharedResources> L
@{
  var images = Model.Images.OrderBy(i => i.SortOrder).ToList();
}

<div class="section">
  <div class="container">
    <nav aria-label="breadcrumb" class="mb-4">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">@L["Home"]</a></li>
        <li class="breadcrumb-item"><a href="/Collections">@L["Collections"]</a></li>
        <li class="breadcrumb-item active" aria-current="page">@(ViewBag.TranslatedTitle as string ?? Model.Title)</li>
      </ol>
    </nav>

    <div class="row g-4">
      <div class="col-12 col-lg-7">
        <div class="card mb-3">
          <div class="swiper mySwiper">
            <div class="swiper-wrapper">
              @foreach(var i in images){
                <div class="swiper-slide">
                  <img class="gallery-image w-100" alt="@Model.Title" style="width: 100%; height: 500px; object-fit: cover; cursor: zoom-in;"
                       src="/uploads/images/@i.FileName-960.jpg"
                       data-full="/uploads/images/@i.FileName-1600.jpg"
                       srcset="/uploads/images/@i.FileName-480.jpg 480w, /uploads/images/@i.FileName-960.jpg 960w, /uploads/images/@i.FileName-1600.jpg 1600w" />
                </div>
              }
            </div>
            <div class="swiper-pagination"></div>
            <div class="swiper-button-prev">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="15 18 9 12 15 6"></polyline>
              </svg>
            </div>
            <div class="swiper-button-next">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </div>
          </div>
        </div>
        
        @if (Model.Status == AAS.Web.Models.CollectionStatus.Available)
        {
          <div class="card mb-3">
            <div class="card-body">
              <button class="btn btn-primary w-100 btn-lg" data-bs-toggle="modal" data-bs-target="#interestModal">
                @L["I'm interested"]
              </button>
            </div>
          </div>
        }
        
        @if(!string.IsNullOrEmpty(Model.AudioPath)){
          <div class="card">
            <div class="card-body">
              <h5>@L["Audio Description"]</h5>
              <audio controls class="w-100" src="@Model.AudioPath"></audio>
            </div>
          </div>
        }
      </div>
      
      <div class="col-12 col-lg-5">
        <div class="card">
          <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <span class="badge badge-gold">@L[Model.Category.ToString()]</span>
              @if (Model.Status == AAS.Web.Models.CollectionStatus.Sold)
              {
                <span class="badge bg-danger fs-6">@L["Sold"]</span>
              }
              else if (Model.Price.HasValue)
              {
                <span class="badge bg-success fs-6">@L["Available"]</span>
              }
            </div>
            
            <h1 style="font-size: 2rem;">@Html.Raw(Html.Encode(ViewBag.TranslatedTitle as string ?? Model.Title))</h1>
            
            @if (Model.Status == AAS.Web.Models.CollectionStatus.Available && Model.Price.HasValue)
            {
              <div class="mb-3 p-3 bg-light rounded">
                <div class="d-flex justify-content-between align-items-center">
                  <span class="text-muted">@L["Available for"]:</span>
                  <h3 class="mb-0 text-gold">
                    @if (Model.Currency == AAS.Web.Models.Currency.EUR)
                    {
                      @string.Format("{0:N0} â‚¬", Model.Price)
                    }
                    else
                    {
                      @string.Format("$ {0:N0}", Model.Price)
                    }
                  </h3>
                </div>
              </div>
            }
            
            <div style="white-space: pre-wrap;">
              @Html.Raw(Html.Encode(ViewBag.TranslatedDescription as string ?? Model.Description).Replace("\n", "<br/>"))
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Lightbox Modal for Full Screen Gallery -->
<div class="modal fade" id="lightboxModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="true" data-bs-keyboard="true">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content bg-black">
      <div class="modal-header border-0" style="position: absolute; top: 0; right: 0; z-index: 1060; background: rgba(0,0,0,0.5);">
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0 d-flex align-items-center justify-content-center">
        <div class="swiper lightboxSwiper" style="width: 100%; height: 100vh;">
          <div class="swiper-wrapper">
            @foreach(var i in images){
              <div class="swiper-slide d-flex align-items-center justify-content-center">
                <img alt="@Model.Title" style="max-width: 95%; max-height: 95vh; object-fit: contain;"
                     src="/uploads/images/@i.FileName-1600.jpg" />
              </div>
            }
          </div>
          <div class="swiper-pagination"></div>
          <div class="swiper-button-prev">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
          </div>
          <div class="swiper-button-next">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="interestModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">@L["Send inquiry"]</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-secondary mb-4">Fill out the form below and our specialist will contact you within 12 hours.</p>
        <form id="inqForm">
          @Html.AntiForgeryToken()
          <input type="hidden" name="collectionId" value="@Model.Id" />
          <input type="hidden" name="collectionTitle" value="@Model.Title" />
          <div class="mb-3">
            <label class="form-label">@L["First name"]</label>
            <input class="form-control" name="FirstName" maxlength="100" required />
          </div>
          <div class="mb-3">
            <label class="form-label">@L["Last name"]</label>
            <input class="form-control" name="LastName" maxlength="100" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input class="form-control" name="Email" type="email" maxlength="160" required />
          </div>
          <div class="mb-3">
            <label class="form-label">@L["Phone"]</label>
            <input class="form-control" name="Phone" type="tel" maxlength="40" />
          </div>
          <div class="mb-3">
            <label class="form-label">@L["Message"]</label>
            <textarea class="form-control" name="Message" rows="4" maxlength="5000" placeholder="Tell us about your interest..."></textarea>
          </div>
        </form>
        <div id="inqOk" class="alert alert-success d-none">@L["Thank you. We will contact you soon."]</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">@L["Close"]</button>
        <button type="button" class="btn btn-primary" onclick="submitInquiry()">@L["Send"]</button>
      </div>
    </div>
  </div>
</div>

<form id="inqForm" style="display:none;">
@Html.AntiForgeryToken()
</form>

@section Scripts{
<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOMContentLoaded - Initializing Swiper...');
  
  // Wait for Swiper to be available
  var initAttempts = 0;
  var maxAttempts = 10;
  
  function tryInitSwiper() {
    initAttempts++;
    
    if (typeof Swiper !== 'undefined') {
      console.log('Swiper found! Initializing galleries...');
      
      // Main gallery
      var mainSwiper = new Swiper('.mySwiper', {
        loop: true,
        spaceBetween: 10,
        pagination: {
          el: '.mySwiper .swiper-pagination',
          clickable: true,
          type: 'bullets'
        },
        navigation: {
          nextEl: '.mySwiper .swiper-button-next',
          prevEl: '.mySwiper .swiper-button-prev'
        },
        keyboard: {
          enabled: true,
          onlyInViewport: false
        }
      });
      
      console.log('Main Swiper initialized successfully!');
      
      // Lightbox
      var lightboxSwiper = null;
      var lightboxModal = document.getElementById('lightboxModal');
      
      if (lightboxModal) {
        lightboxModal.addEventListener('shown.bs.modal', function() {
          console.log('Lightbox modal opened');
          
          if (!lightboxSwiper) {
            lightboxSwiper = new Swiper('.lightboxSwiper', {
              loop: true,
              spaceBetween: 10,
              pagination: {
                el: '.lightboxSwiper .swiper-pagination',
                clickable: true,
                type: 'bullets'
              },
              navigation: {
                nextEl: '.lightboxSwiper .swiper-button-next',
                prevEl: '.lightboxSwiper .swiper-button-prev'
              },
              keyboard: {
                enabled: true,
                onlyInViewport: false
              }
            });
            console.log('Lightbox Swiper initialized!');
          } else {
            lightboxSwiper.update();
          }
        });
        
        // Open lightbox on image click
        document.querySelectorAll('.gallery-image').forEach(function(img, idx) {
          img.addEventListener('click', function() {
            console.log('Image clicked, opening lightbox');
            mainSwiper.slideTo(idx);
            var bsModal = new bootstrap.Modal(lightboxModal);
            bsModal.show();
          });
        });
        
        console.log('Lightbox event listeners attached');
      }
      
    } else if (initAttempts < maxAttempts) {
      console.log('Swiper not ready yet, attempt ' + initAttempts + '/' + maxAttempts);
      setTimeout(tryInitSwiper, 200);
    } else {
      console.error('Swiper failed to load after ' + maxAttempts + ' attempts');
    }
  }
  
  tryInitSwiper();
});
</script>
}
